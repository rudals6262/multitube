(()=>{"use strict";let e,t,n,o=[],i=0,d=1,l=null,s=0;function r(){return"slide_"+s++}if(!window.YT){var c=document.createElement("script");c.src="https://www.youtube.com/iframe_api";var u=document.getElementsByTagName("script")[0];u.parentNode.insertBefore(c,u)}function a(){document.getElementById("mediabox-content").innerHTML='\n        <div class="buttons">\n            <button onclick="addVideoInputFields()">동영상</button>\n            <button onclick="addImageInputFields()">이미지</button>\n        </div>\n    ',R()}function m(){document.getElementById("mediabox-content").innerHTML='\n        <div class="video-container">\n            <div class="video-frame" style="display: none;">\n                <div id="videoPreview"></div>\n            </div>\n            <div class="time-slider-wrapper">\n                <div class="time-slider-container" style="display: none; overflow-x: auto;">\n                    <div class="slider-track" style="width: 100%;">\n                        <div class="slider-range"></div>\n                        <div class="slider-left-thumb" id="startThumb"></div>\n                        <div class="slider-right-thumb" id="endThumb"></div>\n                        <div class="current-time-indicator" id="currentTimeIndicator"></div>\n                    </div>\n                </div>\n            </div>    \n            <div class="input-group">\n                <input type="text" id="videoLink" placeholder="YouTube 링크" onclick="this.value=\'\'" oninput="handleVideoLinkInput()">\n                <div class="plus-minus-buttons" style="display: none;">\n                    <button onclick="zoomOut()">-</button>\n                    <button onclick="zoomIn()">+</button>\n                </div>\n            </div>\n            <div class="action-buttons">\n                <button class="media-select" onclick="resetMediabox()">미디어 선택</button>\n                <div class="confirm-buttons" style="display: none;">\n                    <button class="confirm" onclick="addSlide()">확인</button>\n                </div>\n            </div>\n        </div>\n    '}function y(e){let t=null,n=e;if(e.includes("youtube.com/shorts/")){const o=e.match(/youtube\.com\/shorts\/([^?]*)/);o&&o[1]&&(t=o[1],n=`https://www.youtube.com/watch?v=${t}`)}else if(e.includes("music.youtube.com/")){const o=e.match(/music\.youtube\.com\/watch\?v=([^&]*)/);o&&o[1]&&(t=o[1],n=`https://www.youtube.com/watch?v=${t}`)}else if(e.includes("youtube.com/live/")){const o=e.match(/youtube\.com\/live\/([^?]*)/);o&&o[1]&&(t=o[1],n=`https://www.youtube.com/watch?v=${t}`)}else{const n=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,o=e.match(n);o&&11===o[2].length&&(t=o[2])}return{videoId:t,updatedUrl:n}}async function v(e){try{const t=await fetch(`http://localhost:3000/api/youtube/${e}`);if(!t.ok)throw new Error("Failed to fetch video details");const n=await t.json();if(n.items&&n.items.length>0){const e=n.items[0];if(e.liveStreamingDetails&&e.liveStreamingDetails.concurrentViewers)return!0}return!1}catch(e){return console.error("Error fetching video details:",e),!1}}function p(){const e=document.getElementById("videoLink"),{videoId:n,updatedUrl:d}=y(e.value);if(n)f(),g(n).then((t=>{i=t,e.value=d,document.querySelector(".video-frame").style.display="block",document.querySelector(".time-slider-wrapper").style.display="block",document.querySelector(".time-slider-container").style.display="block",document.querySelector(".action-buttons .confirm-buttons").style.display="flex",document.querySelector(".input-group .plus-minus-buttons").style.display="inline-block",E(0,100),O()})).catch((e=>{console.error("Error fetching video duration:",e)}));else{const n=o[t];n&&(i=n.videoDuration,e.value=n.videoLink,f(),document.querySelector(".video-frame").style.display="block",document.querySelector(".time-slider-wrapper").style.display="block",document.querySelector(".time-slider-container").style.display="block",document.querySelector(".action-buttons .confirm-buttons").style.display="flex",document.querySelector(".input-group .plus-minus-buttons").style.display="inline-block",E(0,100),O())}}function f(){const e=document.querySelector(".slider-track"),t=document.getElementById("startThumb"),n=document.getElementById("endThumb"),o=document.querySelector(".slider-range"),i=document.getElementById("currentTimeIndicator");e&&t&&n&&o&&i?(e.style.setProperty("--zoom-factor",1),e.style.setProperty("--tick-base",60),t.style.left="0%",n.style.left="100%",B(),i.style.left="0%",d=1,h()):console.error("One or more slider elements are missing.")}function g(t){return new Promise(((n,o)=>{e&&e.destroy(),e=new YT.Player("videoPreview",{height:"300",width:"100%",videoId:t,events:{onReady:e=>{const t=e.target.getDuration();t?(n(t),setTimeout((()=>{h()}),100)):o(new Error("Failed to retrieve video duration"))},onError:e=>{o(e)}}})}))}function h(){const e=document.querySelector(".video-frame"),t=document.querySelector(".slider-track"),n=document.querySelector(".time-slider-wrapper"),o=document.querySelector(".time-slider-container");if(e&&t&&n&&o){const i=e.offsetWidth;t.style.width=i-40+"px",n.style.width=`${i}px`,o.style.width=`${i}px`}}function b(){e&&(e.destroy(),e=null),document.getElementById("videoPreview").innerHTML="",document.querySelector(".video-frame").style.display="none",document.querySelector(".time-slider-container").style.display="none",document.querySelector(".action-buttons").style.display="none",document.querySelector(".plus-minus-buttons").style.display="none"}function S(e){if(console.log("Player is ready"),o[t]){const n=o[t].startTime;e.target.seekTo(n)}setInterval(L,100)}function w(e){e.data==YT.PlayerState.PLAYING&&L()}function E(e=0,t=100){const n=document.querySelector(".slider-track");document.querySelector(".slider-range"),document.getElementById("currentTimeIndicator"),n.querySelectorAll(".slider-left-thumb, .slider-right-thumb").forEach((e=>e.remove()));const o=document.createElement("div");o.className="slider-left-thumb",o.id="startThumb";const d=document.createElement("div");function l(e,t){e.style.left=`${t}%`,B()}function s(e,t,l){const s=n.getBoundingClientRect();let r=(t.clientX-s.left)/s.width*100;r=Math.max(0,Math.min(r,100)),l?r>=parseFloat(d.style.left)&&(r=parseFloat(d.style.left)-1/i*100):r<=parseFloat(o.style.left)&&(r=parseFloat(o.style.left)+1/i*100),e.style.left=`${r}%`,B(),q(parseFloat(o.style.left)/100*i,parseFloat(d.style.left)/100*i)}function r(e){s(o,e,!0)}function c(e){s(d,e,!1)}function u(){document.removeEventListener("mousemove",r),document.removeEventListener("mousemove",c)}d.className="slider-right-thumb",d.id="endThumb",n.appendChild(o),n.appendChild(d),o.addEventListener("mousedown",(function(e){e.preventDefault(),document.addEventListener("mousemove",r),document.addEventListener("mouseup",u)})),d.addEventListener("mousedown",(function(e){e.preventDefault(),document.addEventListener("mousemove",c),document.addEventListener("mouseup",u)})),l(o,e),l(d,t),B(),L()}function I(e){const t=document.getElementById("startThumb");moveThumb(t,e,!0)}function T(e){const t=document.getElementById("endThumb");moveThumb(t,e,!1)}function q(t,o){return new Promise((i=>{n&&clearInterval(n),e&&e.seekTo&&"function"==typeof e.seekTo&&(e.seekTo(t),e.playVideo(),n=setInterval((()=>{if(e&&e.getCurrentTime&&"function"==typeof e.getCurrentTime){const d=e.getCurrentTime();L(),d>=o&&(e.pauseVideo(),e.seekTo(t),clearInterval(n),i())}}),100))}))}function L(){if(e&&e.getCurrentTime){const t=e.getCurrentTime(),n=document.getElementById("startThumb"),o=document.getElementById("endThumb"),d=document.getElementById("currentTimeIndicator");if(!n||!o||!d)return;const l=parseFloat(n.style.left)/100*i,s=parseFloat(o.style.left)/100*i;if(t>=l&&t<=s){const e=(t-l)/(s-l)*100,i=parseFloat(n.style.left),r=i+e/100*(parseFloat(o.style.left)-i);d.style.left=`${r}%`}}}function k(){const e=document.querySelector(".slider-track"),t=document.querySelector(".time-slider-container"),n=document.getElementById("startThumb"),o=document.getElementById("endThumb"),i=document.getElementById("currentTimeIndicator");l||(l=e.offsetWidth);const s=2**(d-1);e.style.width=l*s+"px",e.style.transformOrigin="left";const r=((parseFloat(n.style.left)||0)+(parseFloat(o.style.left)||100))/2/100*e.offsetWidth-t.offsetWidth/2;t.scrollLeft=Math.max(0,r),B(),[n,o,i].forEach((e=>{e&&(e.style.transform="translateY(-50%)")})),function(e){document.querySelector(".slider-track").style.setProperty("--zoom-factor",e)}(s),t.style.overflowX="auto"}function B(){const e=document.getElementById("startThumb"),t=document.getElementById("endThumb"),n=document.querySelector(".slider-range");if(e&&t&&n){const o=parseFloat(e.style.left)||0,i=parseFloat(t.style.left)||100;n.style.left=`${o}%`,n.style.width=i-o+"%"}}function x(){const e=document.getElementById("startThumb"),t=document.getElementById("endThumb"),n=(parseFloat(e.style.left),parseFloat(t.style.left),document.querySelector(".slider-track").offsetWidth);document.querySelector(".time-slider-container").offsetWidth/n*i/2>=30&&(d=d+1,k())}function $(){d>1&&(d--,k(),1===d)&&(document.querySelector(".slider-track").style.width=`${l}px`,document.querySelector(".time-slider-container").style.overflowX="hidden")}function F(){const e=document.querySelector(".buttons");e&&(e.removeEventListener("click",C),e.addEventListener("click",C));const t=document.querySelector(".preview-btn");t&&(t.removeEventListener("click",D),t.addEventListener("click",D)),document.querySelectorAll(".slide").forEach((e=>{e.removeEventListener("click",P),e.addEventListener("click",(()=>P(e.dataset.id)))}));const n=document.querySelector(".group-title input");n&&(n.removeEventListener("input",V),n.addEventListener("input",V));const o=document.querySelector(".description textarea");o&&(o.removeEventListener("input",A),o.addEventListener("input",A))}function C(e){"동영상"===e.target.textContent?m():"이미지"===e.target.textContent&&W()}function D(){0!==document.querySelector(".slides").querySelectorAll(".slide:not(.empty-slide)").length?H():alert("추가된 슬라이드가 없습니다.")}function P(e){G(e)}function V(e){Z(e.target,50)}function A(e){Z(e.target,200),ee(e.target),M(e.target,5)}function M(e,t){const n=e.value.split("\n");n.length>t&&(e.value=n.slice(0,t).join("\n"))}function N(t){const n=document.getElementById("videoLink").value.trim();let d,l;if(n)({videoId:d,updatedUrl:l}=y(n));else{if(!(e&&e.getVideoData&&e.getVideoData().video_id))return;d=e.getVideoData().video_id,l=`https://www.youtube.com/watch?v=${d}`}const s=document.getElementById("startThumb"),r=document.getElementById("endThumb"),c=parseFloat(s.style.left)/100*i,u=parseFloat(r.style.left)/100*i,a=o.findIndex((e=>e.id===t));if(-1===a)return;o[a]={id:t,type:"video",videoId:d,startTime:c,endTime:u,videoDuration:i,videoLink:l};const m=document.querySelector(`.slide[data-id="${t}"]`);m.innerHTML=`\n        <img src="https://img.youtube.com/vi/${d}/0.jpg" alt="Video Thumbnail" style="aspect-ratio: 16/9;">\n        <div class="slide-close">&times;</div>\n    `,m.querySelector(".slide-close").addEventListener("click",(()=>{j(t)})),Q();const v=document.querySelector(".confirm");v.textContent="확인",v.onclick=()=>z(),document.querySelectorAll(".slide.selected").forEach((e=>{e.classList.remove("selected")})),document.querySelector(".empty-slide").classList.add("selected"),O()}function Y(e){return`${Math.floor(e/60)}분 ${Math.floor(e%60)}초`}function O(){setTimeout((()=>{const e=new Event("resize");window.dispatchEvent(e)}),0)}function U(){const e=document.querySelector(".slides");if(e.querySelector(".empty-slide"))return;const t=document.createElement("div");t.className="empty-slide",t.innerHTML='<div class="plus-sign">+</div>',t.addEventListener("click",(()=>{document.querySelectorAll(".slide, .empty-slide").forEach((e=>{e.classList.remove("selected")})),t.classList.add("selected"),a()})),e.appendChild(t)}function R(){const e=document.querySelector(".mediabox");e?e.style.display="block":console.error("Mediabox element not found")}function z(){const t=document.getElementById("videoLink").value.trim();let n,o;if(t)({videoId:n,updatedUrl:o}=y(t));else{if(!(e&&e.getVideoData&&e.getVideoData().video_id))return;n=e.getVideoData().video_id,o=`https://www.youtube.com/watch?v=${n}`}const d=document.getElementById("startThumb"),l=document.getElementById("endThumb"),s=parseFloat(d.style.left)/100*i,c=parseFloat(l.style.left)/100*i,u=r(),a={id:u,type:"video",videoId:n,startTime:s,endTime:c,videoDuration:i,videoLink:o},m=document.querySelector(".slides"),v=document.createElement("div");v.className="slide",v.dataset.id=u,v.dataset.slide=JSON.stringify(a),v.innerHTML=`\n        <img src="https://img.youtube.com/vi/${n}/0.jpg" alt="Video Thumbnail" style="aspect-ratio: 16/9;">\n        <div class="slide-close">&times;</div>\n    `,v.addEventListener("click",(()=>P(u))),v.querySelector(".slide-close").addEventListener("click",(e=>{e.stopPropagation(),j(u)}));const p=m.querySelector(".empty-slide");p?m.insertBefore(v,p):m.appendChild(v),Q(),document.querySelector(".empty-slide")||U(),console.log("Slide added. Current slides in DOM:",m.querySelectorAll(".slide:not(.empty-slide)"))}function H(){const t=document.querySelector(".group-title input").value,n=document.querySelector(".description textarea").value,o=document.querySelector(".slides").querySelectorAll(".slide[data-slide]");if(0===o.length)return void alert("추가된 슬라이드가 없습니다.");const i=Array.from(o).map((e=>JSON.parse(e.dataset.slide))),d=`preview.html?slideQueue=${encodeURIComponent(JSON.stringify(i))}&groupTitle=${encodeURIComponent(t)}&description=${encodeURIComponent(n)}`;console.log("Opening preview window with URL:",d),e&&"function"==typeof e.pauseVideo&&e.pauseVideo(),window.open(d,"previewWindow","width=800,height=860")}function W(){document.getElementById("mediabox-content").innerHTML='\n        <div class="input-group">\n            <input type="file" id="imageInput" accept="image/*">\n            <input type="number" id="imageDuration" placeholder="Duration (seconds)" min="1" value="5">\n        </div>\n        <div class="action-buttons">\n            <button class="media-select" onclick="resetMediabox()">미디어 선택</button>\n            <div class="confirm-buttons">\n                <button class="confirm" onclick="addImageSlide()">확인</button>\n            </div>\n        </div>\n    '}function _(){const e=document.getElementById("imageInput"),t=parseInt(document.getElementById("imageDuration").value)||5;if(e.files&&e.files[0]){const n=e.files[0],i=new FileReader;i.onload=function(e){const n=e.target.result,i=r();o.push({id:i,type:"image",imageUrl:n,duration:t});const d=document.querySelector(".slides"),l=document.createElement("div");l.className="slide",l.dataset.id=i,l.innerHTML=`\n                <img src="${n}" alt="Uploaded Image" style="aspect-ratio: 16/9;">\n                <div class="slide-close">&times;</div>\n            `,l.addEventListener("click",(()=>P(i)));const s=d.querySelector(".empty-slide");s?d.insertBefore(l,s):d.appendChild(l),l.querySelector(".slide-close").addEventListener("click",(e=>{e.stopPropagation(),j(i)})),Q(),document.querySelector(".empty-slide")||U()},i.readAsDataURL(n)}else alert("이미지를 선택해주세요.")}function j(e){const t=document.querySelector(".slides"),n=t.querySelector(`.slide[data-id="${e}"]`);n&&t.removeChild(n),o=o.filter((t=>t.id!==e)),Q(),0===t.querySelectorAll(".slide").length&&U()}function Q(){const e=document.querySelector(".slides");e.querySelectorAll(".slide:not(.empty-slide)").forEach((e=>{e.setAttribute("draggable",!0),e.addEventListener("dragstart",(()=>{e.classList.add("dragging")})),e.addEventListener("dragend",(()=>{e.classList.remove("dragging"),X()}))})),e.addEventListener("dragover",(t=>{t.preventDefault();const n=(o=e,i=t.clientX,[...o.querySelectorAll(".slide:not(.dragging):not(.empty-slide)")].reduce(((e,t)=>{const n=t.getBoundingClientRect(),o=i-n.left-n.width/2;return o<0&&o>e.offset?{offset:o,element:t}:e}),{offset:Number.NEGATIVE_INFINITY}).element);var o,i;const d=document.querySelector(".dragging");null==n||n.classList.contains("empty-slide")?e.insertBefore(d,e.querySelector(".empty-slide")):e.insertBefore(d,n)}))}function X(){const e=document.querySelectorAll(".slide:not(.empty-slide)"),t=Array.from(e).map((e=>{const t=e.dataset.id;return o.find((e=>e.id===t))}));o=t}function J(){document.querySelectorAll(".slide:not(.empty-slide)").forEach(((e,t)=>{e.dataset.index=t}))}function G(n){document.querySelectorAll(".slide, .empty-slide").forEach((e=>{e.classList.remove("selected")}));const d=document.querySelector(`.slide[data-id="${n}"]`);d&&(d.classList.add("selected"),t=o.findIndex((e=>e.id===n)),function(n){const d=o.findIndex((e=>e.id===n));if(-1===d)return;const l=o[d];t=d;const{videoId:s,startTime:r,endTime:c,videoLink:u}=l;document.getElementById("mediabox-content").innerHTML=`\n        <div class="video-frame" style="display: block;">\n            <div id="videoPreview"></div>\n        </div>\n        <div class="time-slider-wrapper" style="display: block;">\n            <div class="time-slider-container" style="display: block; overflow-x: auto;">\n                <div class="slider-track" style="width: 100%;">\n                    <div class="slider-range"></div>\n                    <div class="slider-left-thumb" id="startThumb"></div>\n                    <div class="slider-right-thumb" id="endThumb"></div>\n                    <div class="current-time-indicator" id="currentTimeIndicator"></div>\n                </div>\n            </div>\n        </div>\n        <div class="input-group">\n            <input type="text" id="videoLink" placeholder="YouTube 링크" value="${u}" onclick="this.value=''" oninput="handleVideoLinkInput()">\n            <div class="plus-minus-buttons">\n                <button onclick="zoomOut()">-</button>\n                <button onclick="zoomIn()">+</button>\n            </div>\n        </div>\n        <div class="action-buttons" style="display: flex;">\n            <button class="media-select" style="float: left;" onclick="resetMediabox()">미디어 선택</button>\n            <div style="float: right;">\n                <button class="confirm" onclick="updateSlide('${n}')">수정</button>\n            </div>\n        </div>\n    `,e&&e.destroy(),e=new YT.Player("videoPreview",{height:"300",width:"100%",videoId:s,events:{onReady:function(e){g(s).then((e=>{l.videoDuration=e,i=e;const t=r/e*100,n=c/e*100;document.getElementById("startThumb").style.left=`${t}%`,document.getElementById("endThumb").style.left=`${n}%`,E(t,n),B(),K(),q(r,c)})).catch((e=>{console.error("Error fetching video duration:",e)}))},onStateChange:w}}),R()}(n))}function K(){document.getElementById("mediabox-content");const e=document.querySelector(".video-frame"),t=document.querySelector(".time-slider-wrapper"),n=document.querySelector(".time-slider-container"),o=document.querySelector(".slider-track");if(e&&t&&n&&o){const i=e.offsetWidth;t.style.width=`${i}px`,n.style.width=`${i}px`,o.style.width=i-40+"px"}h()}function Z(e,t){e.value.length>t&&(e.value=e.value.slice(0,t))}function ee(e){e.style.height="auto",e.style.height=`${e.scrollHeight}px`}function te(){if(0===o.length)return void alert("추가된 슬라이드가 없습니다.");let t=0;!function n(){if(t<o.length){const i=o[t];"video"===i.type?function(t){return new Promise((n=>{e&&e.getPlayerState()!==YT.PlayerState.CUED?e.cueVideoById({videoId:t.videoId,startSeconds:t.startTime,endSeconds:t.endTime}):e.loadVideoById({videoId:t.videoId,startSeconds:t.startTime,endSeconds:t.endTime}),e.playVideo();const o=setInterval((()=>{e.getCurrentTime()>=t.endTime&&(clearInterval(o),e.pauseVideo(),n())}),1e3)}))}(i).then((()=>{t++,n()})):"image"===i.type&&function(e){return new Promise((t=>{const n=document.createElement("div");n.className="image-slide",n.innerHTML=`<img src="${e.imageUrl}" alt="Image Slide" style="width: 100%;">`,document.body.appendChild(n),setTimeout((()=>{document.body.removeChild(n),t()}),1e3*e.duration)}))}(i).then((()=>{t++,n()}))}}()}function ne(){return console.log("Current slideQueue:",o),o}function oe(){0!==document.querySelector(".slides").querySelectorAll(".slide[data-slide]").length?H():alert("추가된 슬라이드가 없습니다.")}document.addEventListener("DOMContentLoaded",(()=>{F(),document.querySelector(".mediabox").style.display="none",window.addEventListener("resize",K),U(),function(){const e=document.querySelector(".empty-slide");e&&e.addEventListener("click",(()=>{document.querySelectorAll(".slide, .empty-slide").forEach((e=>{e.classList.remove("selected")})),e.classList.add("selected"),a()}))}()})),window.onYouTubeIframeAPIReady=function(){console.log("YouTube IFrame API is ready"),e=new YT.Player("videoPreview",{height:"300",width:"100%",events:{onReady:S,onStateChange:w}})},document.addEventListener("DOMContentLoaded",(()=>{F(),window.YT&&console.log("YouTube IFrame API is ready"),Object.assign(window,{addVideoInputFields:m,addImageInputFields:W,handleVideoLinkInput:p,zoomIn:x,zoomOut:$,addSlide:z,resetMediabox:a,setupEventListeners:F,setupSlider:E,playSegment:q,moveStart:I,moveEnd:T,resetTrackDisplay:f,fetchVideoDuration:g,adjustSliderTrackWidth:h,resetVideoFrame:b,checkLiveBroadcastStatus:v,makeSlidesSortable:Q,updateSlideIndices:J,updateSlideQueue:X,selectSlide:G,addImageSlide:_,updateLayout:K,openPreviewWindow:H,validateInput:Z,autoExpand:ee,limitTextareaLines:M,updateSlide:N,formatDuration:Y,playSlides:te,getSlideQueue:ne});const e=document.querySelector(".preview-btn");e.removeEventListener("click",oe),e.addEventListener("click",oe),document.querySelector(".media-select").addEventListener("click",a),document.querySelector(".group-title input").addEventListener("input",(e=>{Z(e.target,50)})),document.querySelector(".description textarea").addEventListener("input",(e=>{Z(e.target,200),ee(e.target),M(e.target,5)})),window.addEventListener("resize",K),K()}))})();